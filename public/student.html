<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hjälpkö - elev</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
    <div class="w-full max-w-4xl bg-white rounded-lg shadow-lg p-6 mt-6">
      <form id="queueForm" class="flex items-end gap-4">
        <!-- Kö-id -->
        <div class="flex-1">
          <label class="block mb-1 font-medium caret-transparent">Kö-ID</label>
          <input
            id="code"
            type="text"
            placeholder="AB12"
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
        </div>

        <!-- Namn -->
        <div class="flex-1">
          <label class="block mb-1 font-medium caret-transparent">Namn</label>
          <input
            id="name"
            type="text"
            placeholder="Förnamn Efternamn"
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
        </div>

        <!-- Button -->
        <div>
          <button
            type="submit"
            class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded shadow transition-colors w-full caret-transparent"
          >
            Ställ dig i kö
          </button>
        </div>
      </form>
    </div>

    <div class="w-full max-w-md mt-6 caret-transparent">
      <h2 class="text-xl font-semibold mb-2 caret-transparent">Nuvarande kö</h2>
      <div id="queueList" class="space-y-2 text-gray-700 caret-transparent">
        Väntar på kö-ID…
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const nameInput = document.getElementById("name");
      const codeInput = document.getElementById("code");
      const joinBtn = document.getElementById("joinBtn");
      const queueList = document.getElementById("queueList");

      let currentCode = null;
      let myEntryId = null;

      // Load persisted name
      const savedName = localStorage.getItem("studentName");
      if (savedName) nameInput.value = savedName;

      const form = document.getElementById("queueForm");

      form.onsubmit = (e) => {
        e.preventDefault(); // Prevent page reload

        const code = codeInput.value.trim().toUpperCase();
        const name = nameInput.value.trim();

        if (!code || !name) {
          alert("Ange både namn och kö-ID.");
          return;
        }

        localStorage.setItem("studentName", name);
        currentCode = code;

        socket.emit("queue:add", { code, name });

        socket.offAny();
        socket.on(`queue:update:${code}`, renderQueue);
      };

      function renderQueue(entries) {
        if (!entries.length) {
          queueList.innerHTML =
            '<div class="italic text-gray-500">Kön är tom</div>';
          myEntryId = null;
          return;
        }

        queueList.innerHTML = entries
          .map((e) => {
            const selfButton =
              e.socketId === socket.id
                ? `<button class="ml-2 text-red-500 hover:text-red-700 font-medium" onclick="removeSelf(${e.id})">Ta bort mig</button>`
                : "";
            if (e.socketId === socket.id) myEntryId = e.id;
            return `<div class="flex justify-between items-center bg-white border border-gray-200 rounded px-3 py-2 shadow-sm">
                  <span><b>${e.name}</b></span>
                  ${selfButton}
                </div>`;
          })
          .join("");
      }

      function removeSelf(id) {
        if (!currentCode) return;
        socket.emit("queue:remove:self", { code: currentCode, id });
      }

      socket.on("queue:error", (err) => alert(err.message));
    </script>
  </body>
</html>
